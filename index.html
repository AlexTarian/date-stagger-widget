<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
  </head>
  <body>
    <div style="font:14px system-ui;margin:8px 0;">
      <div><strong>Version</strong> S1</div>
      <div>Start Date: <span id="ui-start">—</span></div>
      <div>End Date: <span id="ui-end">—</span></div>
      <div>Workers: <span id="ui-workers">—</span></div>
    </div>

    <script>
      (function(){
        // ---- tiny DOM helpers
        const $ = (id) => document.getElementById(id);

        // ---- state & emit
        const state = { startDate:'', endDate:'', totalWorkers:0 };
        function updateUI(){
          $('ui-start').textContent   = state.startDate || '—';
          $('ui-end').textContent     = state.endDate   || '—';
          $('ui-workers').textContent = String(state.totalWorkers || '—');
        }
        function setState(patch){
          if ('startDate' in patch)    state.startDate = patch.startDate || '';
          if ('endDate' in patch)      state.endDate   = patch.endDate   || '';
          if ('totalWorkers' in patch) state.totalWorkers = Number(patch.totalWorkers) || 0;
          updateUI();
          try {
            JFCustomWidget.sendData({
              value: JSON.stringify(state),
              valid: true,
              message: ''
            });
          } catch (_){}
        }

        // ---- minimal utils
        function toQID(raw){
          const s = String((raw && (raw.value ?? raw)) || '').trim().replace(/^#/, '');
          const m = s.match(/^input_(\d+)$/i) || s.match(/^(\d+)$/);
          return m ? m[1] : null; // "4"
        }
        function readByIdOnce(qid, cb){
          if (!qid) return cb('');
          try {
            JFCustomWidget.getFieldsValueById([qid], (res)=>{
              // res is either a simple map or an event envelope; handle both
              let map = {};
              if (res && res.type === 'event:receiver') {
                (res.data || []).forEach(r => { map[String(r.selector)] = (r.value && r.value.value) ? r.value.value : r.value; });
              } else {
                map = res || {};
              }
              cb(map[qid] ?? '');
            });
          } catch(_) { cb(''); }
        }
        function listenKeys(keys, handler){
          (keys||[]).forEach(k=>{
            try { JFCustomWidget.listenFromField(k, 'change', v => handler(extract(v))); } catch(_){}
            try { JFCustomWidget.listenFromField(k, 'keyup',  v => handler(extract(v))); } catch(_){}
            try { JFCustomWidget.listenFromField(k, 'blur',   v => handler(extract(v))); } catch(_){}
          });
        }
        function extract(v){
          if (v && typeof v === 'object') {
            if ('value' in v) return v.value;
            if (v.data && v.data[0] && 'value' in v.data[0]) return v.data[0].value;
          }
          return v;
        }
        function startWatcher(qid, onChange, interval=400){
          if (!qid) return ()=>{};
          let last = Symbol('first');
          let stop = false;
          (function tick(){
            if (stop) return;
            readByIdOnce(qid, val => {
              if (val !== last) { last = val; onChange(val); }
              setTimeout(tick, interval);
            });
          })();
          return ()=>{ stop = true; };
        }

        // ---- main
        JFCustomWidget.subscribe('ready', function(){
          // Read settings (IDs only; accept "6" or "input_6")
          const sQ = toQID(JFCustomWidget.getWidgetSetting('startFieldId'));
          const eQ = toQID(JFCustomWidget.getWidgetSetting('endFieldId'));
          const nQ = toQID(JFCustomWidget.getWidgetSetting('totalWorkersFieldId'));

          // Initial pull (batch)
          (function initPull(){
            const ids = [sQ, eQ, nQ].filter(Boolean);
            if (!ids.length) return;
            try {
              JFCustomWidget.getFieldsValueById(ids, (res)=>{
                // coerce
                let map = {};
                if (res && res.type === 'event:receiver') {
                  (res.data || []).forEach(r => { map[String(r.selector)] = (r.value && r.value.value) ? r.value.value : r.value; });
                } else {
                  map = res || {};
                }
                setState({
                  startDate: map[sQ] || '',
                  endDate:   map[eQ] || '',
                  totalWorkers: Number(map[nQ]) || 0
                });
              });
            } catch(_){}
          })();

          // Dates: poll by ID (datepicker events can be spotty)
          startWatcher(sQ, v => setState({ startDate: v }));
          startWatcher(eQ, v => setState({ endDate: v }));

          // Workers: listen to the single input (plus a late read to catch slow prefill)
          const nKeys = nQ ? [`input_${nQ}`] : [];
          listenKeys(nKeys, v => {
            const nVal = Number(v);
            if (!Number.isNaN(nVal)) setState({ totalWorkers: nVal });
          });
          if (nQ) setTimeout(()=> readByIdOnce(nQ, v => {
            const nVal = Number(v);
            if (!Number.isNaN(nVal) && nVal > 0) setState({ totalWorkers: nVal });
          }), 600);

          // Submit
          JFCustomWidget.subscribe('submit', function(){
            JFCustomWidget.sendSubmit({ valid: true, value: JSON.stringify(state) });
          });
        });
      })();
    </script>
  </body>
</html>
