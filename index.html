<!doctype html>
<html>
  <head>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="pragma" content="no-cache" />
  </head>
  <style></style>
  <body>
    <div id="reviewArea">
      <div>Version 12 </div>
      <div>Start Date: <span id="ui-start">—</span></div>
      <div>End Date: <span id="ui-end">—</span></div>
      <div>Workers: <span id="ui-workers">—</span></div>
    </div>
    <script type="text/javascript">
      // --- tiny helpers ---
      const unwrap = v => (v && typeof v === 'object' && 'value' in v) ? v.value : v;
      const toQID  = v => String(v || '').replace(/^input_/, '').trim(); // "input_6" -> "6"
    
      // --- UI helpers ---
      function updateReviewArea({ startDate, endDate, totalWorkers }) {
        if (startDate !== undefined)  document.getElementById('ui-start').textContent   = startDate || '—';
        if (endDate   !== undefined)  document.getElementById('ui-end').textContent     = endDate   || '—';
        if (totalWorkers !== undefined) document.getElementById('ui-workers').textContent = String(totalWorkers ?? '—');
      }
    
      // --- minimal state + logic (no rows, just mirrors host fields) ---
      const state = { startDate: '', endDate: '', totalWorkers: 0 };
    
      function setBounds({ startDate, endDate, totalWorkers }) {
        if (startDate !== undefined)    state.startDate = startDate || '';
        if (endDate !== undefined)      state.endDate = endDate || '';
        if (totalWorkers !== undefined) state.totalWorkers = Number(totalWorkers) || 0;
    
        updateReviewArea(state);
        pushValue(validate().length === 0);
      }
    
      function validate() {
        const errs = [];
        // super simple checks; expand as needed
        if (!state.startDate) errs.push('Missing start date');
        if (!state.endDate)   errs.push('Missing end date');
        if (Number.isNaN(state.totalWorkers) || state.totalWorkers < 0) errs.push('Workers must be ≥ 0');
        return errs;
      }
    
      function serialize() {
        // what you want JotForm to capture as widget value
        return {
          startDate: state.startDate,
          endDate: state.endDate,
          totalWorkers: state.totalWorkers
        };
      }
    
      function pushValue(valid, message) {
        try {
          JFCustomWidget.sendData({
            value: JSON.stringify(serialize()),
            valid,
            message: message || ''
          });
        } catch(_) {}
      }
    
      // --- main wiring ---
      JFCustomWidget.subscribe("ready", function () {
        // read widget settings (IDs) safely
        const sQ = toQID(JFCustomWidget.getWidgetSetting('startFieldId'));
        const eQ = toQID(JFCustomWidget.getWidgetSetting('endFieldId'));
        const nQ = toQID(JFCustomWidget.getWidgetSetting('totalWorkersFieldId'));
    
        // build the ID list we’ll request; drop empties
        const wantIds = [sQ, eQ, nQ].filter(Boolean);
    
        // initial pull by ID (expects an ARRAY of QIDs)
        if (wantIds.length) {
          JFCustomWidget.getFieldsValueById(wantIds, (map) => {
            // map keys are QIDs, e.g., { "4": "2025-10-01", "5": "2025-12-31", "6": "12" }
            const startDate    = sQ ? unwrap(map[sQ]) : '';
            const endDate      = eQ ? unwrap(map[eQ]) : '';
            const totalWorkers = nQ ? Number(unwrap(map[nQ]) || 0) : 0;
    
            setBounds({ startDate, endDate, totalWorkers });  // updates UI + emits
          });
        } else {
          // no IDs? leave UI with placeholders; still emit current (empty) state
          setBounds({});
        }
    
        // live listeners (listen on input_<qid>)
        function listenQID(qid, handler){
          if (!qid) return;
          const id = 'input_' + qid;
          try { JFCustomWidget.listenFromField(id, 'change', handler); } catch(_){}
          try { JFCustomWidget.listenFromField(id, 'keyup',  handler); } catch(_){}
        }
    
        listenQID(sQ, (v)=> setBounds({ startDate: v }));
        listenQID(eQ, (v)=> setBounds({ endDate: v }));
        listenQID(nQ, (v)=> setBounds({ totalWorkers: Number(v)||0 }));
    
        // submit: return final data to the form
        JFCustomWidget.subscribe("submit", function () {
          const errs = validate();
          JFCustomWidget.sendSubmit({
            valid: errs.length === 0,
            value: JSON.stringify(serialize())
          });
        });
      });
    </script>
  </body>
</html>













