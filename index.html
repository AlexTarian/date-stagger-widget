<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="pragma" content="no-cache" />
    <!-- Jotform bridge -->
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

    <!-- ========== ULTRA LOGGER (keep first) ========== -->
    <script>
    (function(){
      const ensureLogPane = () => {
        let pre = document.getElementById('ui-log');
        if (!pre) {
          pre = document.createElement('pre');
          pre.id = 'ui-log';
          pre.style.cssText = 'margin-top:8px;background:#f6f8fa;padding:8px;border-radius:8px;font:12px/1.45 monospace;white-space:pre-wrap;max-height:300px;overflow:auto;';
          document.body && document.body.appendChild(pre);
        }
        return pre;
      };
      const ts  = () => new Date().toISOString();
      const add = (line) => { console.log(line); (ensureLogPane()).textContent += ((ensureLogPane()).textContent? '\n':'') + line; };

      // Global JS error visibility
      window.addEventListener('error', e => add(`[${ts()}] JS error: ${e.message}`));
      window.addEventListener('unhandledrejection', e => add(`[${ts()}] Promise error: ${e.reason && e.reason.message || e.reason}`));

      // Page/env probes
      add(`[${ts()}] page loaded; href=${location.href} referrer=${document.referrer}`);
      add(`[${ts()}] JF present now: ${!!window.JFCustomWidget}`);

      function safeJson(x){ try { return JSON.stringify(x, null, 2); } catch { return String(x); } }

      // Wrap JF API with verbose wrappers once it exists
      (function waitJF(tries=40){
        if (!window.JFCustomWidget) { if (tries<=0){ add(`[${ts()}] JF never appeared`); return; } return setTimeout(()=>waitJF(tries-1), 100); }
        const JF = window.JFCustomWidget;
        const orig = {};
        const capture = (n)=>{ try { orig[n] = JF[n]; } catch(_){} };
        ['subscribe','getWidgetSetting','getWidgetSettings','getFieldsValueById','getFieldsValueByName','listenFromField','sendData','sendSubmit'].forEach(capture);

        if (typeof orig.subscribe === 'function') {
          JF.subscribe = function(eventName, handler){
            add(`[${ts()}] JF.subscribe("${eventName}")`);
            const wrapped = function(arg){ add(`[${ts()}]   ↪ "${eventName}" fired: ${safeJson(arg)}`); return handler && handler(arg); };
            return orig.subscribe.call(JF, eventName, wrapped);
          };
        }
        if (typeof orig.getWidgetSetting === 'function') {
          JF.getWidgetSetting = function(key){ add(`[${ts()}] JF.getWidgetSetting(${safeJson(key)})`); const r = orig.getWidgetSetting.call(JF, key); add(`[${ts()}]   → ${safeJson(r)}`); return r; };
        }
        if (typeof orig.getWidgetSettings === 'function') {
          JF.getWidgetSettings = function(){ add(`[${ts()}] JF.getWidgetSettings()`); const r = orig.getWidgetSettings.call(JF); add(`[${ts()}]   → ${safeJson(r)}`); return r; };
        }
        if (typeof orig.getFieldsValueById === 'function') {
          JF.getFieldsValueById = function(ids, cb){ add(`[${ts()}] JF.getFieldsValueById(${safeJson(ids)})`);
            const wrap = (map)=>{ add(`[${ts()}]   ↩ byId keys: ${Object.keys(map||{}).join(',')}`); add(`[${ts()}]   ↩ byId raw: ${safeJson(map)}`); cb && cb(map); };
            try { return orig.getFieldsValueById.call(JF, ids, wrap); } catch(e){ add(`[${ts()}]   ✖ byId threw: ${e&&e.message||e}`); throw e; }
          };
        }
        if (typeof orig.getFieldsValueByName === 'function') {
          JF.getFieldsValueByName = function(names, cb){ add(`[${ts()}] JF.getFieldsValueByName(${safeJson(names)})`);
            const wrap = (map)=>{ add(`[${ts()}]   ↩ byName keys: ${Object.keys(map||{}).join(',')}`); add(`[${ts()}]   ↩ byName raw: ${safeJson(map)}`); cb && cb(map); };
            try { return orig.getFieldsValueByName.call(JF, names, wrap); } catch(e){ add(`[${ts()}]   ✖ byName threw: ${e&&e.message||e}`); throw e; }
          };
        }
        if (typeof orig.listenFromField === 'function') {
          JF.listenFromField = function(key, evt, handler){ add(`[${ts()}] JF.listenFromField(${safeJson(key)}, ${safeJson(evt)})`);
            const wrap = (v)=>{ add(`[${ts()}]   ↪ listen "${evt}" from ${key}: ${safeJson(v)}`); return handler && handler(v); };
            try { return orig.listenFromField.call(JF, key, evt, wrap); } catch(e){ add(`[${ts()}]   ✖ listen threw: ${e&&e.message||e}`); throw e; }
          };
        }
        if (typeof orig.sendData === 'function') {
          JF.sendData = function(payload){ add(`[${ts()}] JF.sendData(${safeJson(payload)})`); try { return orig.sendData.call(JF, payload); } catch(e){ add(`[${ts()}]   ✖ sendData threw: ${e&&e.message||e}`); throw e; } };
        }
        if (typeof orig.sendSubmit === 'function') {
          JF.sendSubmit = function(payload){ add(`[${ts()}] JF.sendSubmit(${safeJson(payload)})`); try { return orig.sendSubmit.call(JF, payload); } catch(e){ add(`[${ts()}]   ✖ sendSubmit threw: ${e&&e.message||e}`); throw e; } };
        }
        add(`[${ts()}] ✔ JF logging wrappers installed`);
      })();
    })();
    </script>
    <!-- ========== /ULTRA LOGGER ========== -->
  </head>

  <body>
    <div id="reviewArea" style="font:14px system-ui; margin:8px 0;">
      <div><strong>Version</strong> 21</div>
      <div>Start Date: <span id="ui-start">—</span></div>
      <div>End Date: <span id="ui-end">—</span></div>
      <div>Workers: <span id="ui-workers">—</span></div>
    </div>

    <!-- ========== WIDGET LOGIC ========== -->
    <script>
      (function(){
        const $ = (id) => document.getElementById(id);
        const log = (m) => { const el = $('ui-log'); if (el) el.textContent += (el.textContent?'\n':'') + m; console.log(m); };
      
        // --- envelope → plain map
        function coerceJFMap(res){
          if (res && res.type !== 'event:receiver') return res || {};
          const out = {};
          const arr = res && Array.isArray(res.data) ? res.data : [];
          for (const row of arr) {
            const key = String(row.selector ?? row.name ?? '');
            if (!key) continue;
            let val = row.value;
            if (val && typeof val === 'object' && 'value' in val) val = val.value;
            out[key] = val;
          }
          return out;
        }
        // event payload coercer
        function coerceValue(v){
          if (v && typeof v === 'object') {
            if ('value' in v) return v.value;
            if ('data' in v && Array.isArray(v.data) && v.data[0] && 'value' in v.data[0]) return v.data[0].value;
          }
          return v;
        }
      
        // === IDs ONLY ===
        // Accept "4", "input_4", "input_4_pick" → return qid ("4") and all date sub-keys
        function normalizeQid(raw){
          const s = String((raw && (raw.value ?? raw)) || '').trim().replace(/^#/, '');
          let qid = null;
          let m = s.match(/^input_(\d+)(?:_pick)?$/i);
          if (m) qid = m[1];
          if (!qid && /^\d+$/.test(s)) qid = s;
          if (!qid) return { qid: null, listenKeys: [] };
          const base = `input_${qid}`;
          // include all date-related subcontrols for resilience
          const listenKeys = [base, `${base}_pick`, `month_${qid}`, `day_${qid}`, `year_${qid}`, `lite_mode_${qid}`];
          return { qid, listenKeys };
        }
      
        // multi-key listener
        function listenKeys(keys, handler){
          (keys || []).forEach((key)=>{
            try { JFCustomWidget.listenFromField(key, 'change', v => handler(coerceValue(v))); } catch (_){}
            try { JFCustomWidget.listenFromField(key, 'keyup',  v => handler(coerceValue(v))); } catch (_){}
            try { JFCustomWidget.listenFromField(key, 'blur',   v => handler(coerceValue(v))); } catch (_){}
          });
        }
      
        // One-shot read by ID
        function readByIdOnce(qid, cb){
          try {
            JFCustomWidget.getFieldsValueById([qid], (map)=>{
              const m = coerceJFMap(map) || {};
              cb(m[qid] ?? '');
            });
          } catch (_) { cb(''); }
        }
      
        // Lightweight watcher by ID (for late prefills)
        function startValueWatcher(qid, { intervalMs = 400, maxIdleMs = 300000 }, onChange){
          if (!qid) return () => {};
          let last = undefined, stopped = false, idleMs = 0;
          const tick = () => {
            if (stopped) return;
            readByIdOnce(qid, (val)=>{
              if (val !== last) { last = val; idleMs = 0; try { onChange(val); } catch(_){ } }
              else { idleMs += intervalMs; if (idleMs >= maxIdleMs) { stopped = true; return; } }
              setTimeout(tick, intervalMs);
            });
          };
          tick();
          return () => { stopped = true; };
        }
      
        // Dates: any event → re-fetch authoritative value by QID
        function wireDate(qid, listenKeysArr, setter){
          if (!qid) return;
          const refresh = () => readByIdOnce(qid, (val)=> setter(val || ''));
          listenKeys(listenKeysArr, () => refresh());
        }
      
        // Numbers: event → use payload; also watch by ID to catch late prefills
        function wireNumber(qid, listenKeysArr, setter){
          listenKeys(listenKeysArr, (v)=> setter(Number(v) || 0));
          startValueWatcher(qid, { intervalMs: 400, maxIdleMs: 300000 }, (v)=>{
            const n = Number(v);
            if (!Number.isNaN(n)) setter(n);
          });
        }
      
        // --- minimal state + emit ---
        const state = { startDate:'', endDate:'', totalWorkers:0 };
        function updateUI(){
          $('ui-start').textContent   = state.startDate || '—';
          $('ui-end').textContent     = state.endDate   || '—';
          $('ui-workers').textContent = String(state.totalWorkers || '—');
        }
        function setState(patch){
          if ('startDate' in patch)    state.startDate = patch.startDate || '';
          if ('endDate' in patch)      state.endDate = patch.endDate || '';
          if ('totalWorkers' in patch) state.totalWorkers = Number(patch.totalWorkers) || 0;
          updateUI();
          pushValue(true);
        }
        function serialize(){ return { ...state }; }
        function pushValue(valid, message){
          try { JFCustomWidget.sendData({ value: JSON.stringify(serialize()), valid, message: message || '' }); } catch(e){}
        }
      
        // Initial pull: IDs only (no names)
        function fetchInitialById({ sQ, eQ, nQ }, done){
          const ids = [sQ, eQ, nQ].filter(Boolean);
          const result = { startDate:'', endDate:'', totalWorkers:0 };
          if (!ids.length) return done(result, 'empty');
          JFCustomWidget.getFieldsValueById(ids, (map)=>{
            const m = coerceJFMap(map) || {};
            if (sQ && m[sQ] != null) result.startDate = m[sQ] || '';
            if (eQ && m[eQ] != null) result.endDate   = m[eQ] || '';
            if (nQ && m[nQ] != null) result.totalWorkers = Number(m[nQ] || 0);
            done(result, 'immediate');
          });
        }
      
        // --- main wiring ---
        JFCustomWidget.subscribe("ready", function(){
          log('ready');
      
          // Read QIDs from settings (IDs only)
          const s = normalizeQid(JFCustomWidget.getWidgetSetting('startFieldId'));
          const e = normalizeQid(JFCustomWidget.getWidgetSetting('endFieldId'));
          const n = normalizeQid(JFCustomWidget.getWidgetSetting('totalWorkersFieldId'));
      
          log(`normalized (IDs only) → sQ=${s.qid} eQ=${e.qid} nQ=${n.qid}`);
          log(`listening keys → start:[${(s.listenKeys||[]).join(', ')}] end:[${(e.listenKeys||[]).join(', ')}] workers:[${(n.listenKeys||[]).join(', ')}]`);
      
          // Initial by-ID pull
          fetchInitialById({ sQ: s.qid, eQ: e.qid, nQ: n.qid }, (vals, how)=>{
            log(`initial resolved (${how}) → ${JSON.stringify(vals)}`);
            setState(vals);
          });
      
          // Live wiring
          wireDate(s.qid, s.listenKeys, (v)=> setState({ startDate: v }));
          wireDate(e.qid, e.listenKeys, (v)=> setState({ endDate: v }));
          wireNumber(n.qid, n.listenKeys, (v)=> setState({ totalWorkers: v }));
      
          // One-shot late probe for workers by ID after a short beat
          setTimeout(()=> {
            if (state.totalWorkers === 0 && n.qid) {
              readByIdOnce(n.qid, (v)=> {
                const nVal = Number(v);
                if (!Number.isNaN(nVal) && nVal > 0) setState({ totalWorkers: nVal });
              });
            }
          }, 800);
      
          // Submit
          JFCustomWidget.subscribe("submit", function(){
            JFCustomWidget.sendSubmit({ valid: true, value: JSON.stringify(serialize()) });
          });
        });
      })();
      </script>
    <!-- ========== /WIDGET LOGIC ========== -->
  </body>
</html>





